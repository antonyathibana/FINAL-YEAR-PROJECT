<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Student - Smart Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üéì Smart Attendance</h2>
                <p>Face Recognition System</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/register" class="nav-link active">
                        <i class="fas fa-user-plus"></i>
                        <span>Register Student</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/attendance" class="nav-link">
                        <i class="fas fa-camera"></i>
                        <span>Take Attendance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/view_attendance" class="nav-link">
                        <i class="fas fa-clipboard-list"></i>
                        <span>View Attendance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/reports" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/logout" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>üìù Register New Student</h1>
                <p>Capture student face for attendance recognition</p>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px">
                <!-- ================= FORM ================= -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Student Information</h3>
                    
                    {% if message %}
                    <div class="{{ 'success-message' if message.type == 'success' else 'error-message' }}">
                        {{ message.text }}
                    </div>
                    {% endif %}
                    
                    <form id="registrationForm">
                        <div class="form-group">
                            <label for="student_id">Student ID</label>
                            <input type="text" id="student_id" class="form-control" placeholder="Enter student ID" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="name">Full Name</label>
                            <input type="text" id="name" class="form-control" placeholder="Enter full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="department">Department</label>
                            <select id="department" class="form-control" required>
                                <option value="">Select Department</option>
                                <option>CSE</option>
                                <option>ECE</option>
                                <option>IT</option>
                                <option>MECH</option>
                                <option>CIVIL</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="year">Year</label>
                            <select id="year" class="form-control" required>
                                <option value="">Select Year</option>
                                <option>1st Year</option>
                                <option>2nd Year</option>
                                <option>3rd Year</option>
                                <option>4th Year</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="section">Section</label>
                            <input type="text" id="section" class="form-control" placeholder="Enter section" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Student
                        </button>
                    </form>
                </div>
                
                <!-- ================= CAMERA ================= -->
                <div class="card" style="text-align: center;">
                    <h3 style="margin-bottom: 20px;">Face Capture</h3>
                    
                    <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                        <span id="modelDot" class="status-dot" style="width: 12px; height: 12px; border-radius: 50%; background: #ffc107;"></span>
                        <span id="modelText">Loading models...</span>
                    </div>
                    
                    <div class="video-container" style="max-width: 400px; margin: 0 auto 20px;">
                        <video id="video" autoplay muted></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <img id="preview" style="display: none;">
                    </div>
                    
                    <p id="statusText" style="margin-bottom: 20px; color: var(--text-secondary);">Load models first...</p>
                    
                    <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        <button id="startBtn" class="btn btn-success" disabled>
                            <i class="fas fa-video"></i> Start Camera
                        </button>
                        <button id="captureBtn" class="btn btn-primary" style="display: none;">
                            <i class="fas fa-camera"></i> Capture Face
                        </button>
                        <button id="retakeBtn" class="btn btn-danger" style="display: none;">
                            <i class="fas fa-redo"></i> Retake
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ================= MANAGE STUDENTS ================= -->
            <div class="card" style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px;">
                    <i class="fas fa-users"></i> Manage Students
                    <button class="btn btn-sm btn-secondary" onclick="loadStudents()" style="float: right;">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </h3>
                
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Year</th>
                                <th>Section</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="studentsList">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading students...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <p>Are you sure you want to delete this student?</p>
            <p id="deleteStudentName" style="font-weight: bold; color: var(--danger);"></p>
            <p style="color: var(--text-secondary); font-size: 14px;">
                <i class="fas fa-exclamation-triangle"></i> 
                This will also delete all attendance records for this student!
            </p>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    
    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const preview = document.getElementById("preview");
        
        const startBtn = document.getElementById("startBtn");
        const captureBtn = document.getElementById("captureBtn");
        const retakeBtn = document.getElementById("retakeBtn");
        
        const modelDot = document.getElementById("modelDot");
        const modelText = document.getElementById("modelText");
        const statusText = document.getElementById("statusText");
        
        let stream = null;
        let faceDescriptor = null;
        let modelsLoaded = false;
        
        /* ---------- LOAD MODELS ---------- */
        async function loadModels() {
            try {
                const URL = "https://justadudewhohacks.github.io/face-api.js/models";
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(URL)
                ]);
                modelsLoaded = true;
                modelDot.style.background = "#28a745";
                modelText.innerText = "Models loaded";
                startBtn.disabled = false;
                statusText.innerText = "Click Start Camera";
            } catch (e) {
                modelDot.style.background = "#dc3545";
                modelText.innerText = "Model error";
                showToast("Failed to load face detection models", "error");
            }
        }
        
        /* ---------- CAMERA ---------- */
        startBtn.onclick = async () => {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            startBtn.style.display = "none";
            captureBtn.style.display = "inline-flex";
            statusText.innerText = "Position face & capture";
        };
        
        /* ---------- CAPTURE ---------- */
        captureBtn.onclick = async () => {
            const detections = await faceapi
                .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();
            
            if (detections.length !== 1) {
                showToast("Ensure exactly ONE face is visible", "warning");
                return;
            }
            
            const det = detections[0];
            faceDescriptor = Array.from(det.descriptor);
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            
            preview.src = canvas.toDataURL("image/jpeg");
            preview.style.display = "block";
            video.style.display = "none";
            
            captureBtn.style.display = "none";
            retakeBtn.style.display = "inline-flex";
            statusText.innerText = "Face captured";
            
            stream.getTracks().forEach(t => t.stop());
        };
        
        /* ---------- RETAKE ---------- */
        retakeBtn.onclick = async () => {
            faceDescriptor = null;
            preview.style.display = "none";
            video.style.display = "block";
            retakeBtn.style.display = "none";
            captureBtn.style.display = "inline-flex";
            
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        };
        
        /* ---------- SUBMIT ---------- */
        document.getElementById("registrationForm").onsubmit = async (e) => {
            e.preventDefault();
            
            console.log("Form submitted");
            console.log("faceDescriptor exists:", !!faceDescriptor);
            console.log("modelsLoaded:", modelsLoaded);
            
            if (!faceDescriptor) {
                showToast("Capture face first!", "warning");
                return;
            }
            
            const payload = {
                student_id: document.getElementById("student_id").value,
                name: document.getElementById("name").value,
                department: document.getElementById("department").value,
                year: document.getElementById("year").value,
                section: document.getElementById("section").value,
                encoding: faceDescriptor
            };
            
            console.log("Sending payload with", payload.encoding?.length, "descriptor values");
            
            try {
                showLoader();
                const res = await fetch("/register", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    credentials: 'same-origin',  // Include cookies
                    body: JSON.stringify(payload)
                });
                console.log("Response status:", res.status);
                console.log("Response URL:", res.url);
                console.log("Response type:", res.type);
                
                // Check if we were redirected to login
                if (res.url.includes('/login')) {
                    hideLoader();
                    showToast("Session expired! Please login again.", "error");
                    setTimeout(() => window.location.href = '/login', 2000);
                    return;
                }
                
                // Try to get JSON response
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    console.log("Response text:", text.substring(0, 200));
                    hideLoader();
                    showToast("Server error: " + (text.substring(0, 100) || "Invalid response"), "error");
                    return;
                }
                
                const data = await res.json();
                console.log("Response data:", data);
                hideLoader();
                
                if (res.ok && data.type === "success") {
                    showToast("Student Registered Successfully!", "success");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.text || `Error: ${res.status}`, "error");
                }
            } catch (err) {
                console.error("Fetch error:", err);
                hideLoader();
                showToast("Network error: " + err.message, "error");
            }
        
        };
        
        
        /* ---------- LOAD STUDENTS LIST ---------- */
        async function loadStudents() {
            const tbody = document.getElementById('studentsList');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            
            try {
                const res = await fetch('/api/students', {
                    credentials: 'same-origin'
                });
                
                if (res.url.includes('/login')) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">Please login to view students</td></tr>';
                    return;
                }
                
                const students = await res.json();
                
                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;"><i class="fas fa-users"></i> No students registered yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td><strong>${s.student_id}</strong></td>
                        <td>${s.name}</td>
                        <td>${s.department}</td>
                        <td>${s.year}</td>
                        <td>${s.section}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${s.student_id}', '${s.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading students:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--danger);">Error loading students</td></tr>';
            }
        }
        
        /* ---------- DELETE STUDENT ---------- */
        let studentToDelete = null;
        
        function confirmDelete(studentId, studentName) {
            studentToDelete = { id: studentId, name: studentName };
            document.getElementById('deleteStudentName').innerText = `${studentName} (${studentId})`;
            document.getElementById('deleteModal').classList.add('show');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            studentToDelete = null;
        }
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!studentToDelete) return;
            
            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            btn.disabled = true;
            
            try {
                const res = await fetch(`/api/students/${studentToDelete.id}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const data = await res.json();
                
                if (data.status === 'success') {
                    showToast('Student deleted successfully!', 'success');
                    closeDeleteModal();
                    loadStudents();  // Refresh the list
                } else {
                    showToast(data.message || 'Error deleting student', 'error');
                }
            } catch (err) {
                showToast('Network error occurred', 'error');
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        };
        
        loadModels();
        loadStudents();
    </script>
</body>
</html>
